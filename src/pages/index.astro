---
import Layout from "../layouts/Layout.astro";
import PostRow from "../components/PostRow.astro";
import TagFilter from "../components/TagFilter.astro";
import SortDropDown from "../components/SortDropDown.astro";
import DifficultyDropDown from "../components/DifficultyDropDown.astro";
import { sortPostsById, getAllUniqueTags } from "../utils/postHelper.ts";
import { getCollection } from "astro:content";
import { LEETCODE_COLLECTION, ZEROJUDGE_COLLECTION } from "../constants";
import { UI_TEXT } from "../i18n/ui";
import "../styles/post-list.css";

// 抓取文章並排序 (預設: 題號 小 -> 大)
const leetcodePosts = await getCollection(LEETCODE_COLLECTION);
const zerojudgePosts = await getCollection(ZEROJUDGE_COLLECTION);
const sortedPosts = sortPostsById([...leetcodePosts, ...zerojudgePosts]);

// 獲取所有標籤
const allTagsCN = getAllUniqueTags(sortedPosts);

const uniqueTags = Array.from(allTagsCN).sort();
---

<Layout title={UI_TEXT.nav_all.cn}>
  <div class="page-container">
    <div class="filter-bar">
      <div class="search-wrapper">
        <i class="bx bx-search search-icon"></i>
        <input
          type="text"
          id="text-search"
          placeholder={UI_TEXT.search_keywords_placeholder.cn}
          autocomplete="off"
          data-cn-placeholder={UI_TEXT.search_keywords_placeholder.cn}
          data-en-placeholder={UI_TEXT.search_keywords_placeholder.en}
        />
      </div>

      <!-- 篩選標籤 -->
      <TagFilter tags={uniqueTags} />

      <!-- Sort Dropdown -->
      <SortDropDown />

      <!-- Difficulty Filter -->
      <div class="difficulty-filter-wrapper">
        <DifficultyDropDown />
      </div>

      <!-- 篩選結果數量 -->
      <div class="result-count" id="result-count">
        {UI_TEXT.result_count_prefix.cn}
        {sortedPosts.length}
        {UI_TEXT.result_count_suffix.cn}
      </div>
    </div>

    <div class="file-list-container">
      <div class="file-list-header post-list-grid">
        <div class="col-icon"></div>
        <div
          class="col-title"
          data-cn={UI_TEXT.col_title.cn}
          data-en={UI_TEXT.col_title.en}
        >
          {UI_TEXT.col_title.cn}
        </div>
        <div
          class="col-difficulty"
          data-cn={UI_TEXT.col_difficulty.cn}
          data-en={UI_TEXT.col_difficulty.en}
        >
          {UI_TEXT.col_difficulty.cn}
        </div>
        <div
          class="col-tags"
          data-cn={UI_TEXT.col_tags.cn}
          data-en={UI_TEXT.col_tags.en}
        >
          {UI_TEXT.col_tags.cn}
        </div>
        <div
          class="col-date"
          data-cn={UI_TEXT.col_date.cn}
          data-en={UI_TEXT.col_date.en}
        >
          {UI_TEXT.col_date.cn}
        </div>
      </div>

      <div id="post-list">
        {
          sortedPosts.map((post) => {
            return <PostRow post={post} />;
          })
        }
      </div>

      <div
        id="no-results"
        style="display: none; padding: 2rem; text-align: center; color: var(--color-fg-muted);"
      >
        沒有找到符合的題目。
      </div>
    </div>
  </div>
</Layout>

<script>
  import { initFilterSystem } from "../scripts/postFilter";
  initFilterSystem();
</script>

<style>
  .page-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .filter-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .search-wrapper {
    position: relative;
    flex: 1;
    min-width: 200px;
  }

  .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-fg-muted);
  }

  #text-search {
    width: 100%;
    padding: 8px 12px 8px 36px;
    background-color: var(--color-canvas-subtle);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    color: var(--color-fg-default);
    outline: none;
  }

  #text-search:focus {
    border-color: var(--color-accent-fg);
    background-color: var(--color-canvas-default);
  }

  /* 列表樣式 */
  .file-list-container {
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    background-color: color-mix(
      in srgb,
      var(--color-card-bg) var(--bg-overlay-alpha),
      transparent
    );
    overflow: hidden;
  }

  .file-list-header {
    /* Grid layout handled by .post-list-grid */
    padding: 16px;
    background-color: color-mix(
      in srgb,
      var(--color-canvas-subtle) var(--bg-overlay-alpha),
      transparent
    );
    border-bottom: 1px solid var(--color-border-default);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-fg-default);
  }

  .col-icon {
    /* width managed by grid */
  }

  .col-title {
    padding-right: 1rem;
  }

  /* Difficulty, Tags, Date widths handled by grid */

  .result-count {
    font-size: 0.85rem;
    color: var(--color-fg-muted);
    margin-left: auto;
  }

  @media (max-width: 768px) {
    .file-list-header,
    .col-icon,
    .col-difficulty {
      display: none;
    }
    .search-wrapper {
      min-width: 100%;
      order: 1;
    }
    /* TagFilter 元件會自己處理樣式，這裡只需要調整順序 */
    :global(.tag-filter-container) {
      order: 2;
    }

    .result-count {
      order: 4;
      width: 100%;
      text-align: right;
      margin-top: 8px;
    }
  }
</style>
