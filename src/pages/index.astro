---
import Layout from "../layouts/Layout.astro";
import PostRow from "../components/PostRow.astro";
import TagFilter from "../components/TagFilter.astro";
import { sortPostsByDate, getAllUniqueTags } from "../utils/postHelper.ts";
import { getCollection } from "astro:content";
import { LEETCODE_COLLECTION } from "../constants";

// 抓取文章並排序
const sortedPosts = sortPostsByDate(await getCollection(LEETCODE_COLLECTION));

// 獲取所有標籤
const allTagsCN = getAllUniqueTags(sortedPosts);

const uniqueTags = Array.from(allTagsCN).sort();
---

<Layout title="所有文章">
  <div class="page-container">
    <div class="filter-bar">
      <div class="search-wrapper">
        <i class="bx bx-search search-icon"></i>
        <input
          type="text"
          id="text-search"
          placeholder="搜尋題目關鍵字..."
          autocomplete="off"
        />
      </div>

      <!-- 篩選標籤 -->
      <TagFilter tags={uniqueTags} />

      <!-- Sort Dropdown -->
      <div class="sort-dropdown-container">
        <button id="sort-btn" class="lang-btn" aria-label="排序">
          <i class="bx bx-sort-alt-2"></i>
          <span class="sort-label">日期 (新→舊)</span>
        </button>
        <div id="sort-menu" class="sort-menu">
          <div class="sort-option active" data-field="date" data-order="desc">
            日期 (新→舊)
          </div>
          <div class="sort-option" data-field="date" data-order="asc">
            日期 (舊→新)
          </div>
          <!-- <div class="sort-option" data-field="id" data-order="asc">
            題號 (小→大)
          </div>
          <div class="sort-option" data-field="id" data-order="desc">
            題號 (大→小)
          </div> -->
        </div>
      </div>

      <!-- 語言切換按鈕 -->
      <button id="lang-toggle" class="lang-btn" aria-label="切換語言">
        <span class="lang-text">EN</span>
      </button>

      <!-- 篩選結果數量 -->
      <div class="result-count" id="result-count">
        共 {sortedPosts.length} 篇
      </div>
    </div>

    <div class="file-list-container">
      <div class="file-list-header">
        <div class="col-icon"></div>
        <div class="col-title">題目 Title</div>
        <div class="col-tags">標籤 Tags</div>
        <div class="col-date">日期 Date</div>
      </div>

      <div id="post-list">
        {
          sortedPosts.map((post) => {
            return <PostRow post={post} />;
          })
        }
      </div>

      <div
        id="no-results"
        style="display: none; padding: 2rem; text-align: center; color: var(--color-fg-muted);"
      >
        沒有找到符合的題目。
      </div>
    </div>
  </div>
</Layout>

<script>
  // --- 互動邏輯 Script ---
  let isEnglish = false;
  let selectedTags = new Set();
  let currentSortField = "date"; // 'date' | 'id'
  let currentSortOrder = "desc"; // 'asc' | 'desc'

  const textSearch = document.getElementById("text-search");
  const langToggle = document.getElementById("lang-toggle");
  const postList = document.getElementById("post-list");
  // @ts-ignore
  const rows = postList.querySelectorAll(".file-row");
  const noResults = document.getElementById("no-results");
  const resultCount = document.getElementById("result-count");

  // Sort Elements
  const sortBtn = document.getElementById("sort-btn");
  const sortMenu = document.getElementById("sort-menu");
  const sortOptions = document.querySelectorAll(".sort-option");
  const sortLabel = sortBtn?.querySelector(".sort-label");

  // 1. 語言切換
  function setLanguage(english: boolean) {
    isEnglish = english;
    localStorage.setItem("isEnglish", String(isEnglish));

    if (langToggle) {
      // @ts-ignore
      langToggle.querySelector(".lang-text").textContent = isEnglish
        ? "EN"
        : "中";
    }

    // 切換所有的 data-cn / data-en 顯示
    document.querySelectorAll("[data-cn]").forEach((el) => {
      // @ts-ignore
      el.textContent = isEnglish ? el.dataset.en : el.dataset.cn;
    });

    // @ts-ignore
    if (textSearch) {
      // @ts-ignore
      textSearch.placeholder = isEnglish
        ? "Search keywords..."
        : "搜尋題目關鍵字...";
    }
  }

  // 初始化狀態
  if (localStorage.getItem("isEnglish") === "true") {
    setLanguage(true);
  }

  langToggle?.addEventListener("click", () => {
    setLanguage(!isEnglish);
  });

  // 2. 監聽標籤篩選事件 (來自 TagFilter 元件)
  let filterLogic = "AND"; // 預設為與邏輯

  document.addEventListener("tag-filter-change", (e) => {
    // @ts-ignore
    const newTags = e.detail.selectedTags;
    // @ts-ignore
    const logic = e.detail.logic; // 取得邏輯: 'AND' | 'OR'

    selectedTags = new Set(newTags);
    if (logic) filterLogic = logic;

    updateFilter();
  });

  // 3. 核心篩選函式
  textSearch?.addEventListener("input", updateFilter);

  function updateFilter() {
    // @ts-ignore
    const term = textSearch.value.toLowerCase();
    let visibleCount = 0;

    rows.forEach((row) => {
      // @ts-ignore
      const rowTags = row.dataset.tagsCn.split(",");
      // @ts-ignore
      const searchContent = row.dataset.search;

      // 邏輯: (標籤符合) AND (搜尋文字符合)
      let matchTags;

      if (selectedTags.size === 0) {
        matchTags = true;
      } else {
        if (filterLogic === "OR") {
          // OR: 只要任一選中標籤存在於文章中即可
          matchTags = Array.from(selectedTags).some((t) => rowTags.includes(t));
        } else {
          // AND: 所有選中標籤都必須存在於文章中 (預設)
          matchTags = Array.from(selectedTags).every((t) =>
            rowTags.includes(t),
          );
        }
      }

      const matchText = searchContent.includes(term);

      if (matchTags && matchText) {
        // @ts-ignore
        row.style.display = "flex";
        visibleCount++;
      } else {
        // @ts-ignore
        row.style.display = "none";
      }
    });

    if (noResults && resultCount) {
      noResults.style.display = visibleCount === 0 ? "block" : "none";
      resultCount.textContent = `共 ${visibleCount} 篇`;
    }

    // 篩選後重新排序 (確保順序正確)
    updateSort();
  }

  // 4. Check URL Params (for Header Search)
  const urlParams = new URLSearchParams(window.location.search);
  const q = urlParams.get("q");
  if (q && textSearch) {
    // @ts-ignore
    textSearch.value = q;
    updateFilter();
  }

  // 5. 排序功能
  sortBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    sortMenu?.classList.toggle("show");
  });

  document.addEventListener("click", () => {
    sortMenu?.classList.remove("show");
  });

  sortOptions.forEach((option) => {
    option.addEventListener("click", (e) => {
      // @ts-ignore
      const field = e.target.dataset.field;
      // @ts-ignore
      const order = e.target.dataset.order;

      currentSortField = field;
      currentSortOrder = order;

      // Update UI
      sortOptions.forEach((o) => o.classList.remove("active"));
      // @ts-ignore
      e.target.classList.add("active");
      if (sortLabel) {
        // @ts-ignore
        sortLabel.textContent = e.target.textContent;
      }

      updateSort();
    });
  });

  function updateSort() {
    if (!postList) return;

    const visibleRows = Array.from(rows).filter(
      (row) =>
        // @ts-ignore
        row.style.display !== "none",
    );

    visibleRows.sort((a, b) => {
      // @ts-ignore
      let aVal = a.dataset[currentSortField];
      // @ts-ignore
      let bVal = b.dataset[currentSortField];

      // 轉為數字比較
      aVal = Number(aVal);
      bVal = Number(bVal);

      if (currentSortOrder === "asc") {
        return aVal - bVal;
      } else {
        return bVal - aVal;
      }
    });

    // DOM Reorder
    // 注意: appendChild 會移動已存在的元素，而不是複製
    visibleRows.forEach((row) => postList.appendChild(row));
  }
</script>

<style>
  /* --- 樣式區 (保持你原本喜歡的深色風格) --- */
  .page-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .filter-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .search-wrapper {
    position: relative;
    flex: 1;
    min-width: 200px;
  }

  .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-fg-muted);
  }

  #text-search {
    width: 100%;
    padding: 8px 12px 8px 36px;
    background-color: var(--color-canvas-subtle);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    color: var(--color-fg-default);
    outline: none;
  }

  #text-search:focus {
    border-color: var(--color-accent-fg);
    background-color: var(--color-canvas-default);
  }

  .lang-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 7px 12px;
    background-color: var(--color-canvas-subtle);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    color: var(--color-fg-default);
    cursor: pointer;
    font-size: 0.9rem;
    height: 38px;
    transition: all 0.2s;
  }

  .lang-btn:hover {
    background-color: var(--color-border-default);
  }

  /* Sort Dropdown Styles */
  .sort-dropdown-container {
    position: relative;
  }

  .sort-menu {
    position: absolute;
    top: 110%;
    right: 0; /* Align right to avoid overflow */
    min-width: 160px;
    background-color: var(--color-canvas-overlay);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: none;
    flex-direction: column;
    overflow: hidden;
  }

  .sort-menu.show {
    display: flex;
  }

  .sort-option {
    padding: 8px 12px;
    font-size: 0.9rem;
    color: var(--color-fg-default);
    cursor: pointer;
    transition: background 0.2s;
  }

  .sort-option:hover {
    background-color: var(--color-canvas-subtle);
  }

  .sort-option.active {
    background-color: rgba(56, 139, 253, 0.15);
    color: #58a6ff;
  }

  /* 列表樣式 */
  .file-list-container {
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    background-color: var(--color-card-bg); /* Use card bg for consistency */
    overflow: hidden;
  }

  .file-list-header {
    display: flex;
    padding: 16px;
    background-color: var(--color-canvas-subtle);
    border-bottom: 1px solid var(--color-border-default);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-fg-default);
  }

  .col-icon {
    width: 32px;
    color: var(--color-fg-muted);
  }

  .col-title {
    flex: 2;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 1rem;
  }
  .col-tags {
    flex: 1.5;
    display: flex;
    align-items: center;
    overflow: hidden;
  }

  .col-date {
    width: 120px;
    text-align: right;
    color: var(--color-fg-muted);
    font-size: 0.85rem;
  }
  .result-count {
    font-size: 0.85rem;
    color: var(--color-fg-muted);
    margin-left: auto;
  }

  @media (max-width: 768px) {
    .file-list-header,
    .col-icon {
      display: none;
    }
    .search-wrapper {
      min-width: 100%;
      order: 1;
    }
    /* TagFilter 元件會自己處理樣式，這裡只需要調整順序 */
    :global(.tag-filter-container) {
      order: 2;
    }
    .lang-btn {
      order: 3;
    }
    .result-count {
      order: 4;
      width: 100%;
      text-align: right;
      margin-top: 8px;
    }
  }
</style>
