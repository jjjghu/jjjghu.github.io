---
import Layout from "../layouts/Layout.astro";
import PostRow from "../components/PostRow.astro";
import TagFilter from "../components/TagFilter.astro";
import SortDropDown from "../components/SortDropDown.astro";
import DifficultyDropDown from "../components/DifficultyDropDown.astro";
import { sortPostsById, getAllUniqueTags } from "../utils/postHelper.ts";
import { getCollection } from "astro:content";
import { LEETCODE_COLLECTION, ZEROJUDGE_COLLECTION } from "../constants";
import { UI_TEXT } from "../i18n/ui";

import "../styles/post-list.css";

// data
const leetcodePosts = await getCollection(LEETCODE_COLLECTION);
const zerojudgePosts = await getCollection(ZEROJUDGE_COLLECTION);
const sortedPosts = sortPostsById([...leetcodePosts, ...zerojudgePosts]);

const allTagsCN = getAllUniqueTags(sortedPosts);
const uniqueTags = Array.from(allTagsCN).sort();
---

<Layout title={UI_TEXT.header_title.cn}>
  <div class="page-container">
    <div class="filter-bar is-loading">
      <div class="search-wrapper">
        <i class="bx bx-search search-icon"></i>
        <input
          type="text"
          id="text-search"
          placeholder={UI_TEXT.search_keywords_placeholder.cn}
          autocomplete="off"
          data-cn-placeholder={UI_TEXT.search_keywords_placeholder.cn}
          data-en-placeholder={UI_TEXT.search_keywords_placeholder.en}
        />
      </div>

      <TagFilter tags={uniqueTags} />

      <div class="filter-controls-group">
        <SortDropDown />
        <div class="difficulty-filter-wrapper">
          <DifficultyDropDown />
        </div>
        <div class="result-count" id="result-count">
          {UI_TEXT.result_count_prefix.cn}
          {sortedPosts.length}
          {UI_TEXT.result_count_suffix.cn}
        </div>
      </div>
    </div>

    <!-- The list container: header + rows share the SAME grid -->
    <div class="file-list-container">
      <div class="file-list-header post-list-grid">
        <div
          class="col-title"
          data-cn={UI_TEXT.col_title.cn}
          data-en={UI_TEXT.col_title.en}
        >
          {UI_TEXT.col_title.cn}
        </div>
        <div
          class="col-difficulty"
          data-cn={UI_TEXT.col_difficulty.cn}
          data-en={UI_TEXT.col_difficulty.en}
        >
          {UI_TEXT.col_difficulty.cn}
        </div>
        <div
          class="col-tags"
          data-cn={UI_TEXT.col_tags.cn}
          data-en={UI_TEXT.col_tags.en}
        >
          {UI_TEXT.col_tags.cn}
        </div>
        <div
          class="col-date"
          data-cn={UI_TEXT.col_date.cn}
          data-en={UI_TEXT.col_date.en}
        >
          {UI_TEXT.col_date.cn}
        </div>
      </div>

      <div id="post-list" class="is-loading">
        {sortedPosts.map((post) => <PostRow post={post} />)}
      </div>
    </div>

    <div
      id="no-results"
      style="display: none; padding: 2rem; text-align: center; color: var(--color-fg-muted);"
    >
      沒有找到符合的題目。
    </div>
  </div>
</Layout>

<script>
  import { initFilterSystem } from "../scripts/postFilter";
  initFilterSystem();
</script>

<style>
  .page-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .filter-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .search-wrapper {
    position: relative;
    flex: 1;
    min-width: 200px;
  }

  .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-fg-muted);
  }

  #text-search {
    width: 100%;
    padding: 8px 12px 8px 36px;
    background-color: var(--color-canvas-subtle);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    color: var(--color-fg-default);
    outline: none;
  }

  #text-search:focus {
    border-color: var(--color-accent-fg);
    background-color: var(--color-canvas-default);
    /* box-shadow: 0 0 15px rgba(88, 166, 255, 0.2); */
  }

  .result-count {
    font-size: 0.85rem;
    color: var(--color-fg-muted);
    margin-left: auto;
  }

  .filter-controls-group {
    display: flex;
    gap: 12px;
    align-items: center;
    flex: 1;
  }

  @media (max-width: 768px) {
    .filter-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: center;
    }

    .filter-controls-group {
      display: contents;
    }

    .search-wrapper {
      order: 1;
      grid-column: span 2;
      width: 100%;
    }

    :global(.sort-dropdown-container) {
      order: 2;
      grid-column: span 1;
    }

    .difficulty-filter-wrapper {
      order: 3;
      grid-column: span 1;
    }

    :global(.tag-filter-container) {
      order: 4;
      grid-column: span 2;
    }

    .result-count {
      order: 5;
      grid-column: span 2;
      text-align: right;
      font-size: 0.8rem;
      margin-top: -4px;
    }

    :global(.drop-btn),
    :global(.dropdown-btn) {
      width: 100%;
      height: 42px;
      justify-content: center;
    }

    :global(.tag-filter-container .dropdown-btn) {
      justify-content: flex-start;
    }

    :global(.diff-btn) {
      justify-content: space-between;
      padding: 0 16px;
    }
  }
</style>
