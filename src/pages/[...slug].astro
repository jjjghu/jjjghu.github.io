---
import { getCollection, render } from "astro:content";
import Layout from "../layouts/Layout.astro";
import { LEETCODE_COLLECTION, ZEROJUDGE_COLLECTION } from "../constants";
import type { PostEntry } from "../types";

import TagBadge from "../components/TagBadge.astro";
import DifficultyBadge from "../components/DifficultyBadge.astro";

// 1. 生成靜態路徑
import { generateSlug } from "../utils/slug-generator.mjs";
import { isPublicPost } from "../utils/postHelper.ts";

export async function getStaticPaths() {
    const leetcodePosts = await getCollection(
        LEETCODE_COLLECTION,
        isPublicPost,
    );
    const zerojudgePosts = await getCollection(
        ZEROJUDGE_COLLECTION,
        isPublicPost,
    );

    // Merge all posts
    const allPosts = [...leetcodePosts, ...zerojudgePosts];

    return allPosts.map((post) => {
        // Use the centralized slug generation logic
        const finalSlug = generateSlug(post.slug, post.data.problem_id);

        return {
            params: { slug: finalSlug },
            props: { post },
        };
    });
}
interface Props {
    post: PostEntry;
}

// 2. 取得資料
const { post } = Astro.props;
const { Content, headings } = await render(post);
const tags = post.data.tags || [];
---

<Layout
    title={post.data.title}
    headings={headings}
    activeCategory={post.collection}
>
    <div class="post-card">
        <div class="post-header-row">
            <h1 id="post-title">
                <a
                    href={post.data.link}
                    id="post-link"
                    data-cn-title={post.data.title}
                    data-cn-link={post.data.link}
                    data-en-title={post.data.en_title || post.data.title}
                    data-en-link={post.data.en_link || post.data.link}
                >
                    {post.data.title}
                </a>
            </h1>
        </div>
        <div class="tags-container">
            <DifficultyBadge difficulty={post.data.difficulty} />
            {tags.map((tag) => <TagBadge tag={tag} />)}
        </div>

        <article class="article-body">
            <Content />
        </article>
    </div>

    <script>
        const postLink = document.getElementById("post-link");
        let isEnglish = false;

        // @ts-ignore
        function updatePostLink(english) {
            isEnglish = english;

            if (postLink) {
                // @ts-ignore
                postLink.textContent = isEnglish
                    ? postLink.dataset.enTitle
                    : postLink.dataset.cnTitle;
                // @ts-ignore
                postLink.href = isEnglish
                    ? postLink.dataset.enLink
                    : postLink.dataset.cnLink;
            }
        }

        // Init
        updatePostLink(localStorage.getItem("isEnglish") === "true");

        // Listen for global change
        document.addEventListener("language-change", (e) => {
            // @ts-ignore
            updatePostLink(e.detail.isEnglish);
        });
    </script>

    <script
        type="application/ld+json"
        set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "Article",
            headline: post.data.title,
            image: [],
            datePublished: post.data.date,
            dateModified: post.data.date,
            author: [
                {
                    "@type": "Person",
                    name: "Chiu",
                    url: "https://jjjghu.github.io",
                },
            ],
        })}
    />

    <style>
        .post-header-row {
            margin-bottom: 0.5rem;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 2rem;
            margin-top: 1rem;
        }

        @media (max-width: 600px) {
            .post-header-row {
                flex-direction: column-reverse;
                align-items: center;
            }
            .tag-container {
                align-items: left;
            }
        }
    </style>
</Layout>
