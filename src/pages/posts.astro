---
import MainLayout from '../layouts/MainLayout.astro';

// 1. 抓取所有文章並按日期排序
const allPosts = await Astro.glob('./posts/*.md');
const sortedPosts = allPosts.sort((a, b) =>
new Date(b.frontmatter.date).valueOf() - new Date(a.frontmatter.date).valueOf()
);

// 2. 收集所有標籤並建立 中文 <-> 英文 對照表
    const tagMap = new Map(); // Key: 中文標籤, Value: 英文標籤
    const allTagsCN = new Set();

    sortedPosts.forEach(post => {
    const cnTags = post.frontmatter.tags || [];
    const enTags = post.frontmatter.en_tags || [];

    cnTags.forEach((tag, index) => {
    allTagsCN.add(tag);
    // 如果有對應的英文標籤，存入對照表
    if (enTags[index]) {
    tagMap.set(tag, enTags[index]);
    } else {
    tagMap.set(tag, tag); // 沒英文就用中文當 fallback
    }
    });
    });

    // 轉成陣列方便操作
    const uniqueTags = Array.from(allTagsCN).sort();

    function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    ---

    <MainLayout title="所有文章 - YUI HUANG">

        <div class="page-container">

            <div class="filter-bar">

                <div class="search-wrapper">
                    <i class='bx bx-search search-icon'></i>
                    <input type="text" id="text-search" placeholder="搜尋題目關鍵字..." autocomplete="off" />
                </div>

                <div class="tag-filter-container">
                    <button id="tag-filter-btn" class="filter-btn">
                        <i class='bx bx-filter-alt'></i> 篩選標籤
                        <span id="selected-count" class="badge" style="display:none">0</span>
                    </button>

                    <div id="tag-dropdown" class="tag-dropdown">
                        <div class="dropdown-header">
                            <span>選擇標籤</span>
                            <button id="clear-tags" class="clear-btn">清除</button>
                        </div>
                        <div class="tag-checkbox-list">
                            {uniqueTags.map(tagCN => (
                            <label class="tag-option">
                                <input type="checkbox" value={tagCN} />
                                <span class="tag-text" data-cn={tagCN} data-en={tagMap.get(tagCN)}>{tagCN}</span>
                            </label>
                            ))}
                        </div>
                    </div>
                </div>

                <button id="lang-toggle" class="lang-btn" aria-label="切換語言">
                    <span class="lang-text">EN</span>
                </button>

                <div class="result-count" id="result-count">
                    共 {sortedPosts.length} 篇
                </div>
            </div>

            <div class="file-list-container">
                <div class="file-list-header">
                    <div class="col-icon"></div>
                    <div class="col-title">題目 Title</div>
                    <div class="col-tags">標籤 Tags</div>
                    <div class="col-date">日期 Date</div>
                </div>

                <div id="post-list">
                    {sortedPosts.map((post) => {
                    const cnTitle = post.frontmatter.title;
                    const enTitle = post.frontmatter.en_title || cnTitle;
                    const cnTags = post.frontmatter.tags || [];
                    const enTags = post.frontmatter.en_tags || cnTags; // Fallback

                    // 組合搜尋字串，包含中英文，方便搜尋
                    const searchContent = `${cnTitle} ${enTitle} ${cnTags.join(' ')} ${enTags.join(' ')}`.toLowerCase();

                    return (
                    <div class="file-row" data-search={searchContent} data-tags-cn={cnTags.join(',')}>
                        <div class="col-icon">
                            <i class='bx bx-file-blank'></i>
                        </div>

                        <div class="col-title">
                            <a href={post.url} class="post-link">
                                <span class="title-text" data-cn={cnTitle} data-en={enTitle}>{cnTitle}</span>
                            </a>
                        </div>

                        <div class="col-tags">
                            <div class="tags-wrapper">
                                {cnTags.map((tag, i) => (
                                <span class="tag-badge">
                                    <span class="tag-content" data-cn={tag} data-en={enTags[i] || tag}>{tag}</span>
                                </span>
                                ))}
                            </div>
                        </div>

                        <div class="col-date">
                            {formatDate(post.frontmatter.date)}
                        </div>
                    </div>
                    );
                    })}
                </div>

                <div id="no-results"
                    style="display: none; padding: 2rem; text-align: center; color: var(--color-fg-muted);">
                    沒有找到符合的題目。
                </div>

            </div>
        </div>
    </MainLayout>

    <script>
        // --- 變數與 DOM 元素 ---
        let isEnglish = false;
        let selectedTags = new Set();

        const textSearch = document.getElementById('text-search');
        const tagFilterBtn = document.getElementById('tag-filter-btn');
        const tagDropdown = document.getElementById('tag-dropdown');
        const clearTagsBtn = document.getElementById('clear-tags');
        const langToggle = document.getElementById('lang-toggle');
        const selectedCountBadge = document.getElementById('selected-count');
        const postList = document.getElementById('post-list');
        const rows = postList.querySelectorAll('.file-row');
        const checkboxes = document.querySelectorAll('.tag-option input[type="checkbox"]');
        const noResults = document.getElementById('no-results');
        const resultCount = document.getElementById('result-count');

        // --- 1. 語言切換邏輯 ---
        langToggle.addEventListener('click', () => {
            isEnglish = !isEnglish;

            // 更新按鈕文字
            langToggle.querySelector('.lang-text').textContent = isEnglish ? "中" : "EN";

            // 更新所有文章標題與標籤顯示
            document.querySelectorAll('[data-cn]').forEach(el => {
                el.textContent = isEnglish ? el.dataset.en : el.dataset.cn;
            });

            // 更新 Placeholder
            textSearch.placeholder = isEnglish ? "Search keywords..." : "搜尋題目關鍵字...";
        });

        // --- 2. 標籤篩選器 UI 邏輯 ---
        // 切換下拉選單顯示
        tagFilterBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            tagDropdown.classList.toggle('show');
        });

        // 點擊外部關閉選單
        document.addEventListener('click', (e) => {
            if (!tagDropdown.contains(e.target) && !tagFilterBtn.contains(e.target)) {
                tagDropdown.classList.remove('show');
            }
        });

        // 處理標籤勾選
        checkboxes.forEach(box => {
            box.addEventListener('change', (e) => {
                const val = e.target.value;
                if (e.target.checked) {
                    selectedTags.add(val);
                } else {
                    selectedTags.delete(val);
                }
                updateFilter();
            });
        });

        // 清除所有標籤
        clearTagsBtn.addEventListener('click', () => {
            selectedTags.clear();
            checkboxes.forEach(box => box.checked = false);
            updateFilter();
        });

        // --- 3. 搜尋與過濾核心邏輯 ---
        textSearch.addEventListener('input', updateFilter);

        function updateFilter() {
            const term = textSearch.value.toLowerCase();
            let visibleCount = 0;

            rows.forEach(row => {
                // 取得該文章的標籤 (中文)
                const rowTags = row.dataset.tagsCn.split(',');
                const searchContent = row.dataset.search;

                // 規則 1: 標籤過濾 (AND 邏輯: 文章必須包含所有選取的標籤)
                // 如果你想要 OR 邏輯 (包含任一標籤即可)，可以把 every 改成 some
                const matchTags = selectedTags.size === 0 || Array.from(selectedTags).every(t => rowTags.includes(t));

                // 規則 2: 文字搜尋 (標題或標籤文字)
                const matchText = searchContent.includes(term);

                if (matchTags && matchText) {
                    row.style.display = 'flex';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // 更新 UI 狀態
            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
            resultCount.textContent = `共 ${visibleCount} 篇`;

            // 更新篩選按鈕上的計數
            if (selectedTags.size > 0) {
                selectedCountBadge.textContent = selectedTags.size;
                selectedCountBadge.style.display = 'inline-block';
                tagFilterBtn.classList.add('active');
            } else {
                selectedCountBadge.style.display = 'none';
                tagFilterBtn.classList.remove('active');
            }
        }
    </script>

    <style>
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- Filter Bar 佈局 --- */
        .filter-bar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        /* 搜尋框 */
        .search-wrapper {
            position: relative;
            flex: 1;
            /* 佔據剩餘空間 */
            min-width: 200px;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-fg-muted);
        }

        #text-search {
            width: 100%;
            padding: 8px 12px 8px 36px;
            background-color: var(--color-canvas-subtle);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            color: var(--color-fg-default);
            outline: none;
        }

        #text-search:focus {
            border-color: var(--color-accent-fg);
            background-color: var(--color-canvas-default);
        }

        /* 按鈕通用樣式 */
        .filter-btn,
        .lang-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 7px 12px;
            background-color: var(--color-canvas-subtle);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            color: var(--color-fg-default);
            cursor: pointer;
            font-size: 0.9rem;
            height: 38px;
            /* 跟 input 一樣高 */
            transition: all 0.2s;
        }

        .filter-btn:hover,
        .lang-btn:hover {
            background-color: var(--color-border-default);
        }

        .filter-btn.active {
            background-color: rgba(56, 139, 253, 0.15);
            color: #58a6ff;
            border-color: rgba(56, 139, 253, 0.4);
        }

        /* 計數小徽章 */
        .badge {
            background-color: var(--color-accent-fg);
            color: white;
            font-size: 0.75rem;
            padding: 0 6px;
            border-radius: 10px;
            line-height: 1.4;
        }

        /* --- 標籤下拉選單 --- */
        .tag-filter-container {
            position: relative;
        }

        .tag-dropdown {
            position: absolute;
            top: 110%;
            left: 0;
            width: 250px;
            background-color: var(--color-canvas-default);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
            /* 預設隱藏 */
            flex-direction: column;
            max-height: 400px;
        }

        .tag-dropdown.show {
            display: flex;
        }

        .dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--color-border-muted);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .clear-btn {
            background: none;
            border: none;
            color: var(--color-fg-muted);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .clear-btn:hover {
            color: var(--color-accent-fg);
        }

        .tag-checkbox-list {
            overflow-y: auto;
            padding: 4px 0;
        }

        .tag-option {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .tag-option:hover {
            background-color: var(--color-canvas-subtle);
        }

        .tag-option input {
            margin-right: 8px;
        }

        /* --- 文章列表樣式 (沿用之前的 GitHub 風格) --- */
        .file-list-container {
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            background-color: var(--color-canvas-default);
            overflow: hidden;
        }

        .file-list-header {
            display: flex;
            padding: 16px;
            background-color: var(--color-canvas-subtle);
            border-bottom: 1px solid var(--color-border-default);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-fg-default);
        }

        .file-row {
            display: flex;
            padding: 10px 16px;
            border-top: 1px solid var(--color-border-muted);
            align-items: center;
        }

        .file-row:first-child {
            border-top: none;
        }

        .file-row:hover {
            background-color: var(--color-canvas-subtle);
        }

        .col-icon {
            width: 32px;
            color: var(--color-fg-muted);
        }

        .col-title {
            flex: 2;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 1rem;
        }

        .post-link {
            color: var(--color-fg-default);
            text-decoration: none;
        }

        .post-link:hover {
            color: var(--color-accent-fg);
            text-decoration: underline;
        }

        .col-tags {
            flex: 1.5;
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .tags-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* 標籤膠囊樣式 */
        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 10px;
            font-size: 12px;
            border-radius: 999px;
            border: 1px solid rgba(240, 246, 252, 0.1);
            background-color: #2d333b;
            color: #c9d1d9;
            white-space: nowrap;
        }

        :global(.light) .tag-badge {
            background-color: #f6f8fa;
            color: #24292f;
            border-color: #d0d7de;
        }

        .col-date {
            width: 120px;
            text-align: right;
            color: var(--color-fg-muted);
            font-size: 0.85rem;
        }

        .result-count {
            font-size: 0.85rem;
            color: var(--color-fg-muted);
            margin-left: auto;
        }

        /* RWD */
        @media (max-width: 768px) {

            .file-list-header,
            .col-icon {
                display: none;
            }

            .file-row {
                flex-wrap: wrap;
                padding: 12px;
            }

            .col-title,
            .col-tags,
            .col-date {
                flex: 100%;
                margin-bottom: 6px;
            }

            .search-wrapper {
                min-width: 100%;
                order: 1;
            }

            .tag-filter-container {
                order: 2;
            }

            .lang-btn {
                order: 3;
            }

            .result-count {
                order: 4;
                width: 100%;
                text-align: right;
                margin-top: 8px;
            }
        }
    </style>