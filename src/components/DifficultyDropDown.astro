---
import "../styles/dropdown.css";
import "../styles/badges.css";
import { UI_TEXT } from "../i18n/ui";
import { getDifficultyClass, getDifficultyLabel } from "../utils/difficulty";

interface Props {
    difficultiesLeetcode?: string[];
    difficultiesZerojudge?: string[];
}

const { difficultiesLeetcode = [], difficultiesZerojudge = [] } = Astro.props;
---

<div
    id="difficulty-dropdown-container"
    class="dropdown-container difficulty-dropdown-container"
>
    <!-- Button -->
    <button id="diff-btn" class="dropdown-btn diff-btn" data-dropdown="diff">
        <span
            class="diff-label"
            data-cn={UI_TEXT.diff_all.cn}
            data-en={UI_TEXT.diff_all.en}>{UI_TEXT.diff_all.cn}</span
        >
        <i class="bx bx-chevron-down"></i>
    </button>

    <!-- Menu -->
    <div id="diff-menu" class="dropdown-menu diff-menu">
        <!-- Default "All" Option -->
        <div
            class="dropdown-option diff-option active"
            data-value="all"
            data-cn={UI_TEXT.diff_all.cn}
            data-en={UI_TEXT.diff_all.en}
        >
            {UI_TEXT.diff_all.cn}
        </div>

        {/* Dynamic Options for Leetcode (Class: diff-group-leetcode) */}
        {
            difficultiesLeetcode.map((diff) => {
                const diffClass = getDifficultyClass(diff);
                const labelCN = getDifficultyLabel(diff, false);
                const labelEN = getDifficultyLabel(diff, true);

                return (
                    <div
                        class={`dropdown-option diff-option diff-group-leetcode ${diffClass}`}
                        data-value={diff.toLowerCase()}
                        data-cn={labelCN}
                        data-en={labelEN}
                    >
                        {labelCN}
                    </div>
                );
            })
        }

        {/* Dynamic Options for Zerojudge (Class: diff-group-zerojudge) */}
        {
            difficultiesZerojudge.map((diff) => {
                const diffClass = getDifficultyClass(diff);
                const labelCN = getDifficultyLabel(diff, false);
                const labelEN = getDifficultyLabel(diff, true);

                return (
                    <div
                        class={`dropdown-option diff-option diff-group-zerojudge ${diffClass}`}
                        data-value={diff.toLowerCase()}
                        data-cn={labelCN}
                        data-en={labelEN}
                        style="display: none;"
                    >
                        {labelCN}
                    </div>
                );
            })
        }
    </div>
</div>

<script>
    import { getSettingsManager } from "../scripts/settingsManager";

    const diffBtn = document.getElementById("diff-btn");
    const diffMenu = document.getElementById("diff-menu");
    const diffOptions = document.querySelectorAll(".diff-option");
    const diffLabel = diffBtn?.querySelector(".diff-label");

    // Groups
    const leetcodeOptions = document.querySelectorAll(".diff-group-leetcode");
    const zerojudgeOptions = document.querySelectorAll(".diff-group-zerojudge");

    // Initialize Settings Manager
    const settings = getSettingsManager();

    // Helper to update label text based on current language
    function updateLabelText(element: HTMLElement | null, isEnglish: boolean) {
        if (!element) return;
        // @ts-ignore
        const text = isEnglish ? element.dataset.en : element.dataset.cn;
        if (text) {
            element.textContent = text;
        }
    }

    // Helper: Switch Visibility based on category
    function updateDropdownVisibility(category: string | null) {
        const target = category || "leetcode";

        if (target === "leetcode") {
            leetcodeOptions.forEach(
                (el) => ((el as HTMLElement).style.display = "block"),
            );
            zerojudgeOptions.forEach(
                (el) => ((el as HTMLElement).style.display = "none"),
            );
        } else {
            leetcodeOptions.forEach(
                (el) => ((el as HTMLElement).style.display = "none"),
            );
            zerojudgeOptions.forEach(
                (el) => ((el as HTMLElement).style.display = "block"),
            );
        }
    }

    // Initial check from URL
    const params = new URLSearchParams(window.location.search);
    updateDropdownVisibility(params.get("category"));

    settings.register({
        key: "difficultyPreference",
        type: "select",
        defaultValue: "all",
        onApply: (value) => {
            // 1. Update Active Option UI
            let matched = false;
            diffOptions.forEach((o) => {
                // @ts-ignore
                const oValue = o.dataset.value;

                // Compare loose equality (string vs string)
                if (oValue === value) {
                    matched = true;
                    o.classList.add("active");
                    // 2. Update Label UI
                    if (diffLabel) {
                        // @ts-ignore
                        diffLabel.dataset.cn = o.dataset.cn;
                        // @ts-ignore
                        diffLabel.dataset.en = o.dataset.en;

                        // Force update text now
                        const isEnglish =
                            localStorage.getItem("isEnglish") === "true";
                        updateLabelText(diffLabel as HTMLElement, isEnglish);
                    }
                } else {
                    o.classList.remove("active");
                }
            });

            // 3. Dispatch Event
            const event = new CustomEvent("difficulty-change", {
                detail: {
                    value,
                },
            });
            document.dispatchEvent(event);
        },
    });

    // Toggle Menu
    diffBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        diffMenu?.classList.toggle("show");
    });

    // Handle Option Click
    diffOptions.forEach((option) => {
        option.addEventListener("click", (e) => {
            e.stopPropagation();
            // @ts-ignore
            const value = e.target.dataset.value;
            settings.set("difficultyPreference", value);

            // Close menu
            diffMenu?.classList.remove("show");
        });
    });

    // Listen for language change to update current label and dropdown items
    document.addEventListener("language-change", (e: any) => {
        const isEnglish = e.detail.isEnglish;

        // Update main label
        updateLabelText(diffLabel as HTMLElement, isEnglish);

        // Update dropdown options
        diffOptions.forEach((opt) => {
            updateLabelText(opt as HTMLElement, isEnglish);
        });
    });

    // Initial sync
    const initialIsEnglish = localStorage.getItem("isEnglish") === "true";
    diffOptions.forEach((opt) => {
        updateLabelText(opt as HTMLElement, initialIsEnglish);
    });
</script>

<style>
    /* Custom Override */
    .diff-btn {
        min-width: 110px;
        justify-content: space-between; /* 預設左右分開 */
        display: flex;
        align-items: center;
    }

    /* 手機版樣式調整 */
    @media (max-width: 768px) {
        .difficulty-dropdown-container {
            width: 100%; /* 確保容器填滿 Grid 格子 */
        }

        .diff-btn {
            min-width: 0; /* 允許縮小 */
            width: 100%;
        }

        /* 避免文字太長時撐開佈局 */
        .diff-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    }
</style>
