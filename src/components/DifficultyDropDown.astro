---
import "../styles/dropdown.css";
import { UI_TEXT } from "../i18n/ui";
---

<div
    id="difficulty-dropdown-container"
    class="dropdown-container difficulty-dropdown-container"
>
    <button id="diff-btn" class="dropdown-btn diff-btn" data-dropdown="diff">
        <span
            class="diff-label"
            data-cn={UI_TEXT.diff_all.cn}
            data-en={UI_TEXT.diff_all.en}>{UI_TEXT.diff_all.cn}</span
        >
        <i class="bx bx-chevron-down"></i>
    </button>
    <div id="diff-menu" class="dropdown-menu diff-menu">
        <div
            class="dropdown-option diff-option active"
            data-value="all"
            data-cn={UI_TEXT.diff_all.cn}
            data-en={UI_TEXT.diff_all.en}
        >
            {UI_TEXT.diff_all.cn}
        </div>
        <div
            class="dropdown-option diff-option"
            data-value="easy"
            data-cn={UI_TEXT.diff_easy.cn}
            data-en={UI_TEXT.diff_easy.en}
        >
            {UI_TEXT.diff_easy.cn}
        </div>
        <div
            class="dropdown-option diff-option"
            data-value="medium"
            data-cn={UI_TEXT.diff_medium.cn}
            data-en={UI_TEXT.diff_medium.en}
        >
            {UI_TEXT.diff_medium.cn}
        </div>
        <div
            class="dropdown-option diff-option"
            data-value="hard"
            data-cn={UI_TEXT.diff_hard.cn}
            data-en={UI_TEXT.diff_hard.en}
        >
            {UI_TEXT.diff_hard.cn}
        </div>
    </div>
</div>

<script>
    import { getSettingsManager } from "../scripts/settingsManager";

    const diffBtn = document.getElementById("diff-btn");
    const diffMenu = document.getElementById("diff-menu");
    const diffOptions = document.querySelectorAll(".diff-option");
    const diffLabel = diffBtn?.querySelector(".diff-label");

    // Initialize Settings Manager
    const settings = getSettingsManager();

    settings.register({
        key: "difficultyPreference",
        type: "select",
        defaultValue: "all",
        onApply: (value) => {
            // 1. Update Active Option UI
            diffOptions.forEach((o) => {
                // @ts-ignore
                const oValue = o.dataset.value;
                if (oValue === value) {
                    o.classList.add("active");
                    // 2. Update Label UI
                    if (diffLabel) {
                        // @ts-ignore
                        diffLabel.textContent = o.textContent.trim();
                        // @ts-ignore
                        diffLabel.dataset.cn = o.dataset.cn;
                        // @ts-ignore
                        diffLabel.dataset.en = o.dataset.en;
                    }
                } else {
                    o.classList.remove("active");
                }
            });

            // 3. Dispatch Event
            const event = new CustomEvent("difficulty-change", {
                detail: {
                    value,
                },
            });
            document.dispatchEvent(event);
        },
    });

    // Toggle Menu
    diffBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        diffMenu?.classList.toggle("show");
    });

    // Handle Option Click
    diffOptions.forEach((option) => {
        option.addEventListener("click", (e) => {
            e.stopPropagation();
            // @ts-ignore
            const value = e.target.dataset.value;
            settings.set("difficultyPreference", value);

            // Close menu
            diffMenu?.classList.remove("show");
        });
    });
</script>

<style>
    /* Custom Override */
    .diff-btn {
        min-width: 110px;
        justify-content: space-between; /* 預設左右分開 */
        display: flex;
        align-items: center;
    }

    /* 手機版樣式調整 */
    @media (max-width: 768px) {
        .difficulty-dropdown-container {
            width: 100%; /* 確保容器填滿 Grid 格子 */
        }

        .diff-btn {
            min-width: 0; /* 允許縮小 */
            width: 100%;
        }

        /* 避免文字太長時撐開佈局 */
        .diff-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    }
</style>
