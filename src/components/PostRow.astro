---
import DifficultyBadge from "./DifficultyBadge.astro";
import TagBadge from "./TagBadge.astro";
import { getTagCN, getTagEN } from "../utils/postHelper";
import { formatDateEN, formatDateCN } from "../utils/dateHelper";
import type { PostEntry } from "../types";

interface Props {
    post: PostEntry;
}

const { post } = Astro.props;

const cnTitle = post.data.title;
const enTitle = post.data.en_title || cnTitle;
const rawTags = post.data.tags || [];

const cnTags = rawTags.map(getTagCN);
const enTags = rawTags.map(getTagEN);
const difficulty = post.data.difficulty;

// 組合搜尋字串 (包含中英文標題與標籤)
const searchContent =
    `${cnTitle} ${enTitle} ${cnTags.join(" ")} ${enTags.join(" ")}`.toLowerCase();

const dateEN = formatDateEN(post.data.date);
const dateCN = formatDateCN(post.data.date);
---

<div
    class="file-row post-list-grid"
    data-search={searchContent}
    data-tags-cn={cnTags.join(",")}
    data-category={post.collection}
    data-date={new Date(post.data.date).valueOf()}
    data-id={Number(post.data.problem_id) || 0}
    data-difficulty={difficulty ? difficulty.toLowerCase() : "none"}
>
    <div class="col-icon">
        <i class="bx bx-file-blank"></i>
    </div>

    <div class="col-title">
        <a href={`/${post.slug}`} class="post-link">
            <span class="title-text" data-cn={cnTitle} data-en={enTitle}>
                {cnTitle}
            </span>
        </a>
    </div>

    <div class="col-difficulty">
        <DifficultyBadge difficulty={difficulty} />
    </div>

    <div class="col-tags">
        <div class="tags-wrapper">
            {
                enTags.map((tag: string) => {
                    return <TagBadge tag={tag} />;
                })
            }
        </div>
    </div>

    <div class="col-date" data-cn={dateCN} data-en={dateEN}>{dateCN}</div>
</div>

<style>
    .file-row {
        /* display: flex; -> Handled by .post-list-grid */
        padding: 10px 16px;
        border-top: 1px solid var(--color-border-muted);
        /* align-items: center; -> Handled by .post-list-grid */
        transition: background-color 0.2s;
    }
    .file-row:first-child {
        border-top: none;
    }
    .file-row:hover {
        background-color: var(--color-canvas-subtle);
    }

    .col-icon {
        color: var(--color-fg-muted);
        display: flex;
        justify-content: center;
    }

    .col-title {
        font-weight: 600;
    }
    .post-link {
        color: var(--color-fg-default);
        text-decoration: none;
    }
    .post-link:hover {
        color: var(--color-accent-fg);
        text-decoration: underline;
    }

    .col-difficulty {
        display: flex; /* keep flex for badge alignment */
    }

    .tags-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .col-date {
        color: var(--color-fg-muted);
        font-size: 0.85rem;
    }

    @media (max-width: 768px) {
        .col-icon {
            display: none;
        }
        .file-row {
            padding: 12px;
            /* .post-list-grid sets display: flex, flex-wrap: wrap */
        }
        .col-title {
            flex: 100%;
            width: 100%; /* Ensure full width on mobile */
            margin-bottom: 6px;
        }
        /* Mobile: 難度、標籤、日期 各自調整 */
        .col-difficulty {
            margin-right: 12px;
            margin-bottom: 6px;
        }
        .col-tags {
            flex: 1; /* 讓標籤佔據剩餘空間 */
            min-width: 100px;
            margin-bottom: 6px;
        }
        .col-date {
            flex: 100%; /* 日期換行 */
            width: 100%;
            text-align: left;
            margin-top: 4px;
        }
    }

    @media (max-width: 768px) {
        .col-icon {
            display: none;
        }
        .file-row {
            flex-wrap: wrap;
            padding: 12px;
        }
        .col-title {
            flex: 100%;
            margin-bottom: 6px;
        }
        /* Mobile: 難度、標籤、日期 各自調整 */
        .col-difficulty {
            width: auto;
            margin-right: 12px;
            margin-bottom: 6px;
        }
        .col-tags {
            flex: 1; /* 讓標籤佔據剩餘空間 */
            min-width: 100px;
            margin-bottom: 6px;
        }
        .col-date {
            flex: 100%; /* 日期換行 */
            text-align: left;
            margin-top: 4px;
        }
    }
</style>
